# Use rootless BuildKit image (best for non-root Jenkins usage)
FROM moby/buildkit:rootless

# Pass Jenkins UID/GID dynamically
ARG UID=1000
ARG GID=1000

# Install required tools for user/group creation
USER root
RUN apk add --no-cache shadow bash

# Create jenkins user and home
RUN set -eux; \
    groupadd -g ${GID} jenkins; \
    useradd -m -d /home/jenkins -u ${UID} -g ${GID} jenkins; \
    mkdir -p /home/jenkins/.local/share/buildkit /home/jenkins/.local/run/buildkit; \
    chown -R jenkins:jenkins /home/jenkins /var/lib/buildkit /run /tmp

# Switch to Jenkins user
USER jenkins

# Environment for rootless buildkit
ENV XDG_RUNTIME_DIR=/home/jenkins/.local/run
ENV BUILDKITD_FLAGS=--addr=unix:///home/jenkins/.local/run/buildkit/buildkitd.sock

ENTRYPOINT ["buildkitd"]