FROM moby/buildkit:buildx-stable-1

ARG UID=1000
ARG GID=1000

USER root
RUN set -eux; \
    # create group and user entries without useradd/groupadd
    echo "jenkins:x:${GID}:" >> /etc/group; \
    echo "jenkins:x:${UID}:${GID}:Jenkins:/home/jenkins:/bin/sh" >> /etc/passwd; \
    mkdir -p /home/jenkins/.local/share/buildkit /home/jenkins/.local/run/buildkit; \
    chown -R ${UID}:${GID} /home/jenkins /var/lib/buildkit /run /tmp

USER jenkins
ENV XDG_RUNTIME_DIR=/home/jenkins/.local/run
ENV BUILDKITD_FLAGS=--addr=unix:///home/jenkins/.local/run/buildkit/buildkitd.sock
ENTRYPOINT ["buildkitd"]